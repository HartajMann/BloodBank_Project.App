@page "/Register"
@using BloodBank_Project.Data
<div class="mb-3">
	<label class="form-label">Phone Number</label>
	<input type="text" class="form-control" @bind="donor.PhoneNumber" >
</div>
<button type="button" class="btn btn-primary" @onclick="FetchData">fetch</button>
<div class="mb-3">
	<label class="form-label">Name</label>
	<input type="text" class="form-control" @bind="donor.Name">
</div>
<div class="mb-3">
	<label class="form-label">Gender</label>
	<input type="text" class="form-control" @bind="donor.Gender">
</div>
<div class="mb-3">
	<label class="form-label">Address</label>
	<input type="text" class="form-control" @bind="donor.Address">
</div>
<div class="mb-3">
	<label class="form-label">City/Town</label>
	<input type="text" class="form-control" @bind="donor.City">
</div>
<div class="mb-3">
	<label f class="form-label">Blood Group</label>
	<select class="form-select" aria-label="Default select example" @bind="donor.BloodGroup">
		<option value="">Select</option>
		<option value="O+">O+</option>
		<option value="O-">O-</option>
		<option value="AB+">AB+</option>
		<option value="AB-">AB-</option>
		<option value="A+">A+</option>
		<option value="A-">A-</option>
		<option value="B+">B+</option>
		<option value="B-">B-</option>
	</select>
</div>
<div class="mb-3">
	<label class="form-label">Age</label>
	<input type="number" class="form-control" @bind="donor.Age">
</div>
<button type="button" class="btn btn-primary" @onclick="RegisterDonor">Register</button>
<button type="button" class="btn btn-primary" @onclick="UpdateDonor">Update database</button>
<button type="button" class="btn btn-primary" @onclick="DeleteDonor">Delete</button>
<button type="button" class="btn btn-primary" @onclick="clear">Clear</button>


@code {
	Donor donor = new Donor();
	DbmaManager Dbma = new DbmaManager();
	private void clear()
	{
		donor = new Donor();
	}
	private async Task RegisterDonor()
	{
		try
		{
			if (string.IsNullOrEmpty(donor.PhoneNumber) || string.IsNullOrEmpty(donor.Name)||
			string.IsNullOrEmpty(donor.Gender) || string.IsNullOrEmpty(donor.Address)||
			string.IsNullOrEmpty(donor.City) || string.IsNullOrEmpty(donor.BloodGroup) || string.IsNullOrEmpty(donor.Age.ToString()))
			{
				throw new InvalidDonorRegisterException("Fill All Fields");
			}
			bool result = await Dbma.RegisterDonorAsync(donor);
			if (result)
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "Registered Successfully", "OK");
			}
			else
			{
				throw new InvalidDonorRegisterException("There was an error try again");
			}
		}
		catch (InvalidDonorRegisterException ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", ex.Message, "OK");
		}
		catch (Exception ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", $"An error occurred: {ex.Message}", "OK");
		}
	}
	private async Task FetchData()
	{
		try
		{
			if(string.IsNullOrEmpty(donor.PhoneNumber))
			{
				throw new InvalidDonorRegisterException("Please Enter A Phone Number");
			}
			Donor fetchedDonor = await Dbma.FetchDonorAsync(donor.PhoneNumber);
			if (fetchedDonor != null)
			{
				donor = fetchedDonor;
			}
			else
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "No donor found with that phone number.", "OK");
			}
		}
		catch (InvalidDonorRegisterException ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", ex.Message, "OK");
		}
		catch (Exception ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", $"An error occurred: {ex.Message}", "OK");
		}
	}

	private async Task UpdateDonor()
	{
		try
		{
			if (string.IsNullOrEmpty(donor.PhoneNumber) || string.IsNullOrEmpty(donor.Name) ||
			string.IsNullOrEmpty(donor.Gender) || string.IsNullOrEmpty(donor.Address) ||
			string.IsNullOrEmpty(donor.City) || string.IsNullOrEmpty(donor.BloodGroup) || string.IsNullOrEmpty(donor.Age.ToString()))
			{
				throw new InvalidDonorRegisterException("Fill All Fields");
			}
			bool result = await Dbma.UpdateDonorAsync(donor);
			if (result)
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "Updated Successfully", "OK");
			}
			else
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "Update failed. Please try again. Also Note That Phone Number Cannot be Changed.", "OK");
			}
		}
		catch (InvalidDonorRegisterException ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", ex.Message, "OK");
		}
		catch (Exception ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", $"An error occurred: {ex.Message}", "OK");
		}
	}

	private async Task DeleteDonor()
	{
		try
		{
			bool result = await Dbma.DeleteDonorAsync(donor.PhoneNumber);
			if (result)
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "Deleted Successfully", "OK");
				clear();
			}
			else
			{
				await Application.Current.MainPage.DisplayAlert("Alert", "Delete failed. Please try again.", "OK");
			}
		}
		catch (Exception ex)
		{
			await Application.Current.MainPage.DisplayAlert("Alert", $"An error occurred: {ex.Message}", "OK");
		}
	}

}